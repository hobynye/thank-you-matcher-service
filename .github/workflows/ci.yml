name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: read

jobs:
  tests:
    name: Tests (${{ matrix.test-type }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        test-type: [unit, integration]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # Compile once per job, no tests
      - name: Compile
        run: mvn -B -ntp -DskipTests compile

      - name: Run unit tests
        if: matrix.test-type == 'unit'
        run: mvn -B -ntp test jacoco:report

      - name: Run integration tests
        if: matrix.test-type == 'integration'
        env:
          SPRING_PROFILES_ACTIVE: test
        run: mvn -B -ntp verify -DskipUnitTests=true jacoco:report-integration

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-${{ matrix.test-type }}
          path: |
            target/site/jacoco
            target/site/jacoco-it

  sonar:
    name: Sonar Scan & Quality Gate
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Download unit coverage
        uses: actions/download-artifact@v4
        with:
          name: jacoco-unit
          path: target/site/jacoco

      - name: Download integration coverage
        uses: actions/download-artifact@v4
        with:
          name: jacoco-integration
          path: target/site/jacoco-it

      - name: Sonar scan (Quality Gate enforced)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST: ${{ vars.SONAR_HOST }}
          SONAR_ORG: ${{ vars.SONAR_ORG }}
          SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
        run: |
          mvn -B -ntp sonar:sonar \
            -Dsonar.login=${{ SONAR_TOKEN }} \
            -Dsonar.host.url=${{ SONAR_HOST }} \
            -Dsonar.organization=${{ SONAR_ORG }} \
            -Dsonar.projectKey=${{ SONAR_PROJECT_KEY }}
            -Dsonar.qualitygate.wait=true \
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }}